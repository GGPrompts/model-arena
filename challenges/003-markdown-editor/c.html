<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Model Markdown Editor</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1621;
      --panel-2: #111b2a;
      --border: #1e2a3a;
      --text: #e6edf3;
      --muted: #9fb0c3;
      --accent: #4ea1ff;
      --accent-2: #7cc4ff;
      --danger: #ff6b6b;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      height: 100%;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(78, 161, 255, 0.12), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(124, 196, 255, 0.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,20,0.9), rgba(11,15,20,0.7));
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .toolbar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: auto;
      color: var(--text);
      letter-spacing: 0.2px;
      font-weight: 600;
    }

    .brand-badge {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: linear-gradient(135deg, var(--accent), #2d6bff);
      display: grid;
      place-items: center;
      color: white;
      font-weight: 800;
      font-family: var(--mono);
      box-shadow: 0 6px 18px rgba(78,161,255,0.35);
    }

    button, select {
      background: linear-gradient(180deg, #132033, #0f1a2a);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 9px 12px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 80ms ease, border-color 120ms ease, box-shadow 120ms ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }

    button:hover, select:hover {
      border-color: #2a3c55;
      box-shadow: var(--shadow);
    }

    button:active {
      transform: translateY(1px);
    }

    button.primary {
      border-color: rgba(78,161,255,0.45);
      background: linear-gradient(180deg, rgba(78,161,255,0.18), rgba(78,161,255,0.08));
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      padding-left: 4px;
      white-space: nowrap;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1200px;
      margin: 18px auto 26px;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status {
      display: flex;
      gap: 12px;
      color: var(--muted);
      font-size: 13px;
      padding: 2px 2px 6px;
    }

    .panes {
      flex: 1;
      min-height: 70vh;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .pane {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .pane-header {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01));
      color: var(--muted);
      font-size: 13px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .editor-shell {
      position: relative;
      flex: 1;
      min-height: 0;
      background: var(--panel);
    }

    .editor-shell pre,
    .editor-shell textarea {
      margin: 0;
      padding: 16px 18px 18px;
      border: 0;
      width: 100%;
      height: 100%;
      font-family: var(--mono);
      font-size: 14.5px;
      line-height: 1.6;
      tab-size: 2;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
    }

    .editor-shell pre {
      position: absolute;
      inset: 0;
      pointer-events: none;
      color: var(--text);
      background: transparent;
    }

    .editor-shell textarea {
      position: relative;
      resize: none;
      background: transparent;
      color: transparent;
      caret-color: var(--accent-2);
      outline: none;
      z-index: 2;
    }

    .editor-shell textarea::selection {
      background: rgba(78,161,255,0.28);
      color: transparent;
    }

    /* Markdown syntax highlight tokens */
    .tok { color: var(--text); }
    .tok-syntax { color: #7aa2f7; }
    .tok-heading { color: #9ece6a; font-weight: 700; }
    .tok-quote { color: #e0af68; }
    .tok-em { color: #bb9af7; font-style: italic; }
    .tok-strong { color: #f7768e; font-weight: 700; }
    .tok-code { color: #7dcfff; }
    .tok-link { color: #4ea1ff; text-decoration: underline; text-decoration-color: rgba(78,161,255,0.45); }
    .tok-list { color: #73daca; }
    .tok-hr { color: #565f89; }

    .preview {
      flex: 1;
      min-height: 0;
      padding: 18px 20px 24px;
      overflow: auto;
      background: var(--panel-2);
    }

    /* Markdown render styles */
    .md {
      max-width: 70ch;
      margin: 0 auto;
      color: var(--text);
      font-size: 16px;
      line-height: 1.75;
    }

    .md h1, .md h2, .md h3, .md h4, .md h5, .md h6 {
      line-height: 1.25;
      margin: 1.6em 0 0.6em;
      color: #f2f7ff;
      letter-spacing: 0.2px;
    }

    .md h1 { font-size: 2.1em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
    .md h2 { font-size: 1.7em; border-bottom: 1px solid var(--border); padding-bottom: 0.25em; }
    .md h3 { font-size: 1.35em; }
    .md h4 { font-size: 1.15em; }

    .md p { margin: 0.8em 0; color: var(--text); }

    .md a { color: var(--accent-2); }
    .md a:hover { color: var(--accent); }

    .md img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: block;
      margin: 1.1em 0;
    }

    .md pre {
      background: #0c1420;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      overflow: auto;
      line-height: 1.6;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }

    .md code {
      font-family: var(--mono);
      background: rgba(125, 207, 255, 0.12);
      border: 1px solid rgba(125, 207, 255, 0.25);
      padding: 0.12em 0.35em;
      border-radius: 8px;
      font-size: 0.92em;
    }

    .md pre code {
      background: transparent;
      border: 0;
      padding: 0;
      border-radius: 0;
      font-size: 0.95em;
      color: #dbe9ff;
    }

    .md blockquote {
      margin: 1em 0;
      padding: 0.4em 1em;
      border-left: 3px solid var(--accent);
      background: rgba(78, 161, 255, 0.08);
      border-radius: 10px;
      color: #d6e6ff;
    }

    .md ul, .md ol {
      margin: 0.8em 0 0.8em 1.25em;
      padding: 0;
    }

    .md li { margin: 0.35em 0; }

    .md hr {
      border: 0;
      border-top: 1px solid var(--border);
      margin: 1.8em 0;
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.02);
    }

    @media (max-width: 1000px) {
      .panes { grid-template-columns: 1fr; }
      .md { max-width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <div class="brand" aria-label="App name">
        <div class="brand-badge">MD</div>
        Markdown Studio
      </div>

      <label for="templateSelect" class="hint">Template</label>
      <select id="templateSelect" aria-label="Select template"></select>
      <button id="loadTemplateBtn" class="primary" type="button">Load</button>
      <button id="exportBtn" type="button">Export HTML</button>
      <div class="hint" id="saveHint">Live preview</div>
    </div>
  </header>

  <main>
    <div class="status">
      <div id="wordCount">0 words</div>
      <div id="charCount">0 chars</div>
      <div class="chip-row" aria-hidden="true">
        <div class="chip">Split View</div>
        <div class="chip">Syntax Highlight</div>
        <div class="chip">Self-contained</div>
      </div>
    </div>

    <section class="panes" aria-label="Markdown editor and preview">
      <article class="pane" aria-label="Editor pane">
        <div class="pane-header">Editor</div>
        <div class="editor-shell" id="editorShell">
          <pre id="highlight" aria-hidden="true"></pre>
          <textarea id="editor" spellcheck="false" aria-label="Markdown editor"></textarea>
        </div>
      </article>

      <article class="pane" aria-label="Preview pane">
        <div class="pane-header">Preview</div>
        <div class="preview">
          <div id="preview" class="md" aria-live="polite"></div>
        </div>
      </article>
    </section>
  </main>

  <script>
    (function () {
      const editor = document.getElementById('editor');
      const highlight = document.getElementById('highlight');
      const preview = document.getElementById('preview');
      const templateSelect = document.getElementById('templateSelect');
      const loadTemplateBtn = document.getElementById('loadTemplateBtn');
      const exportBtn = document.getElementById('exportBtn');
      const wordCountEl = document.getElementById('wordCount');
      const charCountEl = document.getElementById('charCount');

      const templates = [
        {
          name: 'Welcome',
          content: `# Markdown Studio\n\nA modern, self-contained Markdown editor with live preview.\n\n## Features\n\n- Split pane editor and preview\n- Lightweight syntax highlighting\n- Proper markdown rendering\n- Templates and HTML export\n\n### Inline formatting\n\nUse **bold**, *italic*, and \`inline code\`.\n\n### Links and images\n\n[OpenAI](https://openai.com)\n\n![Gradient](https://picsum.photos/800/300)\n\n### Code fences\n\n\`\`\`js\nfunction greet(name) {\n  return \`Hello, ${'${name}'}!\`;\n}\n\nconsole.log(greet('world'));\n\`\`\`\n\n> Tip: Try loading other templates from the dropdown.\n\n---\n\nHappy writing!`
        },
        {
          name: 'Release Notes',
          content: `# Release Notes â€” v1.2.0\n\n## Highlights\n\n- Faster preview rendering\n- Improved Markdown parsing\n- New export-to-HTML button\n\n## Fixes\n\n1. Resolved scroll sync jitter\n2. Corrected list rendering edge cases\n3. Hardened HTML escaping\n\n## Migration\n\n\`\`\`bash\nnpm install my-package@latest\n\`\`\`\n\nSee the [changelog](https://example.com/changelog) for details.`
        },
        {
          name: 'Project README',
          content: `# Project Name\n\nShort description of what this project does and why it exists.\n\n## Getting Started\n\n### Prerequisites\n\n- Node.js 20+\n- A modern browser\n\n### Installation\n\n\`\`\`bash\ngit clone https://example.com/repo.git\ncd repo\nnpm install\nnpm run dev\n\`\`\`\n\n## Usage\n\nWrite some Markdown on the left; preview renders on the right.\n\n## Roadmap\n\n- [ ] Add keyboard shortcuts\n- [ ] Add table support\n- [ ] Add plugin system\n\n## License\n\nMIT`
        }
      ];

      function escapeHtml(str) {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderInline(text) {
        let out = escapeHtml(text);

        // Inline code first to avoid conflicts
        out = out.replace(/`([^`]+?)`/g, (_, code) => `<code>${code}</code>`);

        // Images: ![alt](src)
        out = out.replace(/!\[([^\]]*?)\]\(([^)\s]+)(?:\s+"([^"]*?)")?\)/g, (_, alt, src, title) => {
          const safeAlt = alt || '';
          const safeTitle = title ? ` title="${escapeHtml(title)}"` : '';
          return `<img src="${src}" alt="${escapeHtml(safeAlt)}"${safeTitle} />`;
        });

        // Links: [text](href)
        out = out.replace(/\[([^\]]+?)\]\(([^)\s]+)(?:\s+"([^"]*?)")?\)/g, (_, label, href, title) => {
          const safeTitle = title ? ` title="${escapeHtml(title)}"` : '';
          return `<a href="${href}" target="_blank" rel="noopener noreferrer"${safeTitle}>${label}</a>`;
        });

        // Bold / strong
        out = out.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
        out = out.replace(/__([^_]+?)__/g, '<strong>$1</strong>');

        // Italic / emphasis
        out = out.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
        out = out.replace(/_([^_]+?)_/g, '<em>$1</em>');

        return out;
      }

      function parseMarkdown(md) {
        const lines = md.replace(/\r\n?/g, '\n').split('\n');
        const html = [];

        let i = 0;
        let inCode = false;
        let codeLang = '';
        let codeBuffer = [];
        let listType = null; // 'ul' or 'ol'

        function closeList() {
          if (listType) {
            html.push(`</${listType}>`);
            listType = null;
          }
        }

        function flushParagraph(buffer) {
          if (!buffer.length) return;
          const text = buffer.join(' ').trim();
          if (text) html.push(`<p>${renderInline(text)}</p>`);
          buffer.length = 0;
        }

        const paragraphBuffer = [];

        while (i < lines.length) {
          const raw = lines[i];
          const line = raw;

          // Fenced code blocks
          const fenceMatch = line.match(/^```\s*([\w-]+)?\s*$/);
          if (fenceMatch) {
            if (!inCode) {
              closeList();
              flushParagraph(paragraphBuffer);
              inCode = true;
              codeLang = fenceMatch[1] || '';
              codeBuffer = [];
            } else {
              const code = escapeHtml(codeBuffer.join('\n'));
              const langClass = codeLang ? ` class="language-${codeLang}"` : '';
              html.push(`<pre><code${langClass}>${code}</code></pre>`);
              inCode = false;
              codeLang = '';
              codeBuffer = [];
            }
            i += 1;
            continue;
          }

          if (inCode) {
            codeBuffer.push(line);
            i += 1;
            continue;
          }

          // Horizontal rule
          if (/^\s*(?:---|\*\*\*|___)\s*$/.test(line)) {
            closeList();
            flushParagraph(paragraphBuffer);
            html.push('<hr />');
            i += 1;
            continue;
          }

          // Headings
          const headingMatch = line.match(/^(#{1,6})\s+(.*)$/);
          if (headingMatch) {
            closeList();
            flushParagraph(paragraphBuffer);
            const level = headingMatch[1].length;
            const text = headingMatch[2].trim();
            html.push(`<h${level}>${renderInline(text)}</h${level}>`);
            i += 1;
            continue;
          }

          // Blockquote
          const quoteMatch = line.match(/^>\s?(.*)$/);
          if (quoteMatch) {
            closeList();
            flushParagraph(paragraphBuffer);
            const quoteLines = [];
            while (i < lines.length) {
              const m = lines[i].match(/^>\s?(.*)$/);
              if (!m) break;
              quoteLines.push(m[1]);
              i += 1;
            }
            const inner = parseMarkdown(quoteLines.join('\n'));
            html.push(`<blockquote>${inner}</blockquote>`);
            continue;
          }

          // Lists
          const ulMatch = line.match(/^\s*[-+*]\s+(.*)$/);
          const olMatch = line.match(/^\s*(\d+)\.\s+(.*)$/);
          if (ulMatch || olMatch) {
            flushParagraph(paragraphBuffer);
            const nextType = ulMatch ? 'ul' : 'ol';
            if (listType && listType !== nextType) {
              closeList();
            }
            if (!listType) {
              listType = nextType;
              html.push(`<${listType}>`);
            }
            const itemText = (ulMatch ? ulMatch[1] : olMatch[2]).trim();
            html.push(`<li>${renderInline(itemText)}</li>`);
            i += 1;
            continue;
          }

          // Blank lines separate paragraphs and close lists
          if (/^\s*$/.test(line)) {
            closeList();
            flushParagraph(paragraphBuffer);
            i += 1;
            continue;
          }

          // Default: paragraph content
          paragraphBuffer.push(line.trim());
          i += 1;
        }

        closeList();
        flushParagraph(paragraphBuffer);

        return html.join('\n');
      }

      function highlightMarkdown(md) {
        const escaped = escapeHtml(md);

        // Protect fenced code blocks from other replacements
        const codeBlocks = [];
        const protectedText = escaped.replace(/(^|\n)```[^\n]*\n[\s\S]*?\n```/g, (block) => {
          const token = `\u0000CODEBLOCK${codeBlocks.length}\u0000`;
          codeBlocks.push(block);
          return token;
        });

        let out = protectedText;

        // Headings
        out = out.replace(/^(#{1,6})(\s+)(.*)$/gm, (_, hashes, space, text) => {
          return `<span class="tok-heading">${hashes}</span>${space}<span class="tok-heading">${text}</span>`;
        });

        // Blockquotes
        out = out.replace(/^(>\s?.*)$/gm, '<span class="tok-quote">$1</span>');

        // Horizontal rules
        out = out.replace(/^\s*(---|\*\*\*|___)\s*$/gm, '<span class="tok-hr">$1</span>');

        // Lists
        out = out.replace(/^\s*([-+*]|\d+\.)\s+/gm, (m) => {
          return m.replace(/([-+*]|\d+\.)/, '<span class="tok-list">$1</span>');
        });

        // Inline code
        out = out.replace(/`([^`]+?)`/g, (_, code) => `<span class="tok-code">\`${code}\`</span>`);

        // Bold / strong markers
        out = out.replace(/(\*\*|__)(?=\S)([\s\S]*?\S)\1/g, (m, marker, inner) => {
          return `<span class="tok-strong">${marker}${inner}${marker}</span>`;
        });

        // Italic / emphasis markers (simple heuristic)
        out = out.replace(/(\*|_)(?=\S)([^*_]*?\S)\1/g, (m, marker, inner) => {
          return `<span class="tok-em">${marker}${inner}${marker}</span>`;
        });

        // Links and images
        out = out.replace(/(!?\[[^\]]*\]\([^\)]+\))/g, (m) => `<span class="tok-link">${m}</span>`);

        // Restore code blocks with dedicated styling
        out = out.replace(/\u0000CODEBLOCK(\d+)\u0000/g, (_, idx) => {
          const block = codeBlocks[Number(idx)];
          return `<span class="tok-code">${block}</span>`;
        });

        // Preserve trailing newline so caret positioning remains accurate
        return out + '\n';
      }

      function updateCounts(text) {
        const words = (text.trim().match(/\b\w+\b/g) || []).length;
        wordCountEl.textContent = `${words} words`;
        charCountEl.textContent = `${text.length} chars`;
      }

      function syncScroll() {
        highlight.scrollTop = editor.scrollTop;
        highlight.scrollLeft = editor.scrollLeft;
      }

      function renderAll() {
        const md = editor.value;
        highlight.innerHTML = highlightMarkdown(md);
        preview.innerHTML = parseMarkdown(md);
        updateCounts(md);
        syncScroll();
      }

      function loadTemplateByIndex(idx) {
        const t = templates[idx];
        if (!t) return;
        editor.value = t.content;
        renderAll();
        editor.focus();
      }

      function exportHtml() {
        const md = editor.value;
        const rendered = parseMarkdown(md);
        const doc = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exported Markdown</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #0b0f14; color: #e6edf3; }
    main { max-width: 820px; margin: 40px auto; padding: 0 20px 60px; line-height: 1.75; }
    h1, h2 { border-bottom: 1px solid #1e2a3a; padding-bottom: 0.25em; }
    pre { background: #0f1621; border: 1px solid #1e2a3a; border-radius: 10px; padding: 14px 16px; overflow: auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: rgba(125, 207, 255, 0.12); padding: 0.12em 0.35em; border-radius: 6px; }
    pre code { background: transparent; padding: 0; }
    blockquote { border-left: 3px solid #4ea1ff; padding: 0.4em 1em; background: rgba(78, 161, 255, 0.08); border-radius: 8px; }
    img { max-width: 100%; border-radius: 10px; border: 1px solid #1e2a3a; }
    a { color: #7cc4ff; }
    hr { border: 0; border-top: 1px solid #1e2a3a; margin: 1.8em 0; }
  </style>
</head>
<body>
  <main>
    ${rendered}
  </main>
</body>
</html>`;

        const blob = new Blob([doc], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'markdown-export.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function initTemplates() {
        templates.forEach((t, idx) => {
          const opt = document.createElement('option');
          opt.value = String(idx);
          opt.textContent = t.name;
          templateSelect.appendChild(opt);
        });
        templateSelect.value = '0';
      }

      // Events
      editor.addEventListener('input', renderAll);
      editor.addEventListener('scroll', syncScroll);
      editor.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          e.preventDefault();
          const start = editor.selectionStart;
          const end = editor.selectionEnd;
          const value = editor.value;
          editor.value = value.slice(0, start) + '  ' + value.slice(end);
          editor.selectionStart = editor.selectionEnd = start + 2;
          renderAll();
        }
      });

      loadTemplateBtn.addEventListener('click', () => loadTemplateByIndex(Number(templateSelect.value)));
      templateSelect.addEventListener('change', () => loadTemplateByIndex(Number(templateSelect.value)));
      exportBtn.addEventListener('click', exportHtml);

      // Init
      initTemplates();
      loadTemplateByIndex(0);
    })();
  </script>
</body>
</html>
